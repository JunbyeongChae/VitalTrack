import React, { useEffect, useState } from 'react';
import * as echarts from 'echarts';
import { Link } from 'react-router';
import { getWeightChanges } from '../services/authLogic';
import AirQuality from "../services/AirQuality";
import AIHealthAnalysis from '../services/AIHealthAnalysis';
import {getScheduleListDB} from "../services/workoutLogic";
import {useScheduleContext} from "./workout/Context";
import WoChart from "./workout/WoChart";

const UserHome = () => {
  const [bmiStatus, setBmiStatus] = useState('')
  const user = JSON.parse(localStorage.getItem('user'))
  const { memNo } = user
  const { schedules, setSchedules, lastWeekData, setLastWeekData, signal } = useScheduleContext()

  // BMI ÌåêÏ†ïÏùÑ Í≥ÑÏÇ∞ÌïòÎäî Ìï®Ïàò
  const calculateBmiStatus = () => {
    const memBmi = parseFloat(user.memBmi);
    if (memBmi < 18.5) {
      setBmiStatus('Ï†ÄÏ≤¥Ï§ë üü°');
    } else if (memBmi < 23) {
      setBmiStatus('Ï†ïÏÉÅ üü¢');
    } else if (memBmi < 25) {
      setBmiStatus('Í≥ºÏ≤¥Ï§ë üü°');
    } else if (memBmi < 30) {
      setBmiStatus('Í≤ΩÎèÑÎπÑÎßå üü†');
    } else if (memBmi < 35) {
      setBmiStatus('Ï§ëÎì±ÎèÑÎπÑÎßå üî¥');
    } else {
      setBmiStatus('Í≥†ÎèÑÎπÑÎßå ‚ö†Ô∏è');
    } 
  };
  //Ï≤¥Ï§ëÎ≥ÄÌôî Ï∞®Ìä∏
  useEffect(() => {
    const fetchWeightData = async () => {
      try {
        const data = await getWeightChanges(user.memNo);
        const dates = data.map(item => item.weightDate);
        const weights = data.map(item => item.weight);

        const weightChart = echarts.init(document.getElementById('weightChart'));
        //const activityChart = echarts.init(document.getElementById('activityChart'));

        const weightOption = {
          animation: false,
          tooltip: { trigger: 'axis' },
          xAxis: { type: 'category', data: dates },
          yAxis: { type: 'value' },
          series: [
            {
              data: weights,
              type: 'line',
              smooth: true,
              lineStyle: { color: '#3B82F6' },
              itemStyle: { color: '#3B82F6' },
            },
          ],
        };

        /*const activityOption = {
          animation: false,
          tooltip: { trigger: 'axis' },
          xAxis: { type: 'category', data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] },
          yAxis: { type: 'value' },
          series: [
            {
              name: 'Steps',
              type: 'bar',
              data: [8000, 9200, 7800, 8432, 7900, 8700, 8200],
              itemStyle: { color: '#3B82F6' }
            }
          ]
        };*/

        weightChart.setOption(weightOption);
        //activityChart.setOption(activityOption);

        window.addEventListener('resize', () => {
          weightChart.resize();
          //activityChart.resize();
        });
      } catch (error) {
        console.error('Ï≤¥Ï§ë Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error.message);
      }
    };

    fetchWeightData();
    calculateBmiStatus();
    scheduleList()

    return () => {
      window.removeEventListener('resize', () => {});
    };
  }, []);

  //Ï†ÑÏ≤¥ Ïö¥Îèô ÏùºÏ†ï Ï°∞Ìöå - DB Í≤ΩÏú†
  const scheduleList = async () => {
    // /api -> ÏõπÌéòÏù¥ÏßÄ ÏöîÏ≤≠Ïù¥ ÏïÑÎãå RESTful API ÏöîÏ≤≠ÏûÑÏùÑ Î™ÖÏãú
    const response = await getScheduleListDB({memNo})
    let schedules = []
    if(response){
      schedules = response.data
    }

    const formattedSchedules = schedules.map((schedule) => {
      // 'T'Î°ú Î∞îÍøîÏÑú ISO ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
      const formattedStart = schedule.scheduleStart.replace(" ", "T");  // start ÎÇ†Ïßú Î≥ÄÌôò
      const formattedEnd = schedule.scheduleEnd.replace(" ", "T");  // end ÎÇ†Ïßú Î≥ÄÌôò

      return {
        id: schedule.scheduleId, // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏Ïùò id Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
        title: schedule.workoutName,
        start: formattedStart,  // Î≥ÄÌôòÎêú start ÎÇ†Ïßú ÏÇ¨Ïö©
        end: formattedEnd,  // Î≥ÄÌôòÎêú end ÎÇ†Ïßú ÏÇ¨Ïö©
        color: schedule.color,
        allDay: schedule.allDay,
        extendedProps: {
          isFinished: schedule.isFinished,
          workoutId: schedule.workoutId,
          workoutTimeMin: schedule.workoutTimeMin,
          kcal : schedule.kcal
        }
      }
    })
    setSchedules(formattedSchedules)
  } //end of scheduleList
  //ÏßÄÎÇú 7ÏùºÍ∞Ñ Ïö¥ÎèôÎüâ - DBÎ°úÎ∂ÄÌÑ∞ Í≥ÑÏÇ∞
  const getLast7Workouts = async () => {
    const lastWeek = schedules
        .filter(sc => {
          const now = new Date(); // ÌòÑÏû¨ ÏãúÍ∞Ñ
          const sevenDaysAgo = new Date();
          sevenDaysAgo.setDate(now.getDate() - 6); // 7Ïùº Ï†Ñ ÎÇ†Ïßú (Ïò§Îäò Ìè¨Ìï®Ïù¥ÎØÄÎ°ú -6)
          sevenDaysAgo.setHours(0, 0, 0, 0); // 7Ïùº Ï†ÑÏùò 00:00:00ÏúºÎ°ú ÏÑ§Ï†ï

          const startDate = new Date(sc.start);

          return startDate >= sevenDaysAgo && startDate <= now && sc.extendedProps.isFinished === true;
        }) // Ï°∞Í±¥ Ï†ÅÏö©
        .sort((a, b) => new Date(a.start) - new Date(b.start)) // scheduleStart Í∏∞Ï§Ä ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨
    // const response = await getLast7WorkoutsDB({memNo: memNo})
    setLastWeekData(prev => ({ ...prev, weekSchedules: lastWeek || [] }))
    //console.log(response.data)
    //return lastWeek
  }
  // 1. ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¥
  useEffect(() => {
    const fetchData = async () => {
      await scheduleList()
    }
    fetchData()
  }, [signal]) // ÏùºÏ†ï CRUD Î≥ÄÍ≤Ω Î∞úÏÉùÏãú signal Î≥ÄÍ≤ΩÎê® -> Í∑∏ÎïåÎßàÎã§ Ïä§ÏºÄÏ§Ñ Ïû¨ÎûúÎçîÎßÅ
  // 2. schedulesÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎ©¥ ÏßÄÎÇú 7ÏùºÍ∞Ñ Ïö¥ÎèôÎüâ Ï°∞Ìöå
  useEffect(() => {
    //schedulesÏù¥ ÏÇ≠Ï†úÎêòÏÑú ÎπàÎ∞∞Ïó¥Ïù¥ ÎèºÎèÑ Ïã§ÌñâÌï®
    if (schedules === undefined || schedules === null) return; // Îç∞Ïù¥ÌÑ∞Í∞Ä undefined ÎòêÎäî nullÏù¥Î©¥ Ï¢ÖÎ£å
      getLast7Workouts()
  }, [schedules]) // schedules Î≥ÄÍ≤ΩÎê† ÎïåÎßàÎã§ Ïã§Ìñâ
  // 3. ÏßÄÎÇú 7ÏùºÍ∞Ñ Ïö¥ÎèôÎüâ Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÑ∏ÌåÖ
  useEffect(() => {
    if (lastWeekData.weekSchedules.length === 0) return; // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Ïã§Ìñâ Ïïà Ìï®

    const today = new Date();
    const newDays = [];
    const newTerms = [];
    const newKcal = [];

    // lastWeekDB Îç∞Ïù¥ÌÑ∞Î•º ÎØ∏Î¶¨ ÎÇ†ÏßúÎ≥ÑÎ°ú Îß§ÌïëÌïòÏó¨ Ìö®Ïú®Ï†ÅÏù∏ ÎπÑÍµê
    const lastWeekMap = lastWeekData.weekSchedules.reduce((acc, item) => {
      const scheduleDate = new Date(item.start).toLocaleDateString('ko-KR', { weekday: 'short' });
      acc[scheduleDate] = item.extendedProps.kcal; // ÎÇ†ÏßúÎ•º keyÎ°ú ÏÇ¨Ïö©ÌïòÏó¨ ÏπºÎ°úÎ¶¨Î•º Îß§Ìïë
      return acc;
    }, {});

    let totalKcal = 0
    let activeDays = 0 // Ïö¥ÎèôÌïú ÎÇ†Ïùò ÏàòÎ•º ÏÖà


    for (let i = 6; i > -1; i--) {
      const day = new Date(today);  // Í∞Å ÎÇ†ÏßúÎßàÎã§ ÏÉàÎ°úÏö¥ Date Í∞ùÏ≤¥Î•º ÎßåÎì§Í∏∞ ÏúÑÌï¥
      //console.log(day) //Fri Mar 21 2025 17:06:25 GMT+0900 (ÌïúÍµ≠ ÌëúÏ§ÄÏãú)
      day.setDate(today.getDate() - i);
      const formattedDay = day.toLocaleDateString('ko-KR', { weekday: 'short' });
      // Ìï¥Îãπ ÎÇ†ÏßúÏóê ÏπºÎ°úÎ¶¨Í∞Ä ÏûàÏúºÎ©¥ Ìï¥Îãπ Í∞íÏùÑ, ÏóÜÏúºÎ©¥ 0ÏùÑ ÎÑ£Í∏∞
      const kcal = lastWeekMap[formattedDay] || 0;
      newKcal.push(kcal);
      newDays.push(formattedDay);
      if (kcal > 0) { // Ïö¥ÎèôÌïú ÎÇ†Ïù¥Î©¥
        totalKcal += kcal;
        activeDays += 1;
      }
      if (i === 6 || i === 0) {
        newTerms.push(day.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }));
      }
    } // end of for()

    // Ïö¥ÎèôÌïú ÎÇ†Ïù¥ ÏûàÎã§Î©¥ ÌèâÍ∑†ÏùÑ Í≥ÑÏÇ∞
    const averageKcal = activeDays > 0 ? totalKcal / activeDays : 0

    setLastWeekData(prev => ({
      ...prev,
      yoils: newDays,
      term: newTerms,
      kcal: newKcal,
      kcalMean: averageKcal
    }))
  }, [lastWeekData.weekSchedules])

  return (
    <main className="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div className="grid grid-cols-1 gap-6 lg:grid-cols-4">
        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center">
            <div className="p-3 rounded-full bg-blue-100">
              <i className="fas fa-weight text-custom"></i>
            </div>
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-500">ÌòÑÏû¨ Ï≤¥Ï§ë</p>
              <h3 className="text-lg font-semibold text-gray-900">{localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')).memWeight : 'N/A'} kg</h3>
            </div>
          </div>
        </div>
        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center">
            <div className="p-3 rounded-full bg-green-100">
              <i className="fas fa-heartbeat text-green-600"></i>
            </div>
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-500">BMI</p>
              <h3 className="text-lg font-semibold text-gray-900">{localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')).memBmi : 'N/A'} - {bmiStatus}</h3>
            </div>
          </div>
        </div>
        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center">
            <div className="p-3 rounded-full bg-red-100">
              <i className="fas fa-fire text-red-600"></i>
            </div>
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-500">Ïö¥ÎèôÏπºÎ°úÎ¶¨</p>
              <h3 className="text-lg font-semibold text-gray-900">2,231 kcal</h3>
            </div>
          </div>
        </div>
        <AirQuality />
      </div>

      <div className="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-2">
        <div className="bg-white rounded-lg shadow">
          <div className="p-6">
            <h2 className="text-lg font-medium text-gray-900">ÎÇòÏùò Ï≤¥Ï§ëÎ≥ÄÌôî</h2>
            <div id="weightChart" className="h-80 mt-4"></div>
          </div>
        </div>
        <div className="bg-white rounded-lg shadow">
          <div className="p-6">
            <div className="flex items-center">
              <h2 className="text-lg font-medium text-gray-900">ÏùºÏ£ºÏùº Ïö¥ÎèôÎüâ</h2>
              <Link to={'/workout'} className="ml-auto text-blue-500 hover:text-blue-700 border p-4">
                Ïö¥Îèô Í¥ÄÎ¶¨
              </Link>
            </div>
            {lastWeekData.weekSchedules.length > 0 ?
                <>
           {/* <div id="activityChart" className="h-80 mt-4"></div>*/}
            <WoChart lastWeekDays={lastWeekData.yoils} lastWeekKcal={lastWeekData.kcal}/>
                </>
                :
                <p className="text-center mt-10 text-gray-500">ÏßÄÎÇúÏ£º Ïö¥ÎèôÎüâÏù¥ ÏóÜÏäµÎãàÎã§.</p>
            }
          </div>
        </div>
      </div>

      <div className="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-3">
        <div className="bg-white rounded-lg shadow">
          <div className="p-6">
            <h2 className="text-lg font-medium text-gray-900">Ïò§Îäò Ïö¥ÎèôÏä§ÏºÄÏ•¥</h2>
            <div className="mt-4 space-y-4">
              <div className="flex items-center">
                <div className="w-2 h-2 rounded-full bg-red-500"></div>
                <p className="ml-3 text-sm text-gray-500">Îã¨Î¶¨Í∏∞ - 7:00 AM</p>
              </div>
              <div className="flex items-center">
                <div className="w-2 h-2 rounded-full bg-yellow-400"></div>
                <p className="ml-3 text-sm text-gray-500">ÌååÏõåÏöîÍ∞Ä - 9:00 AM</p>
              </div>
              <div className="flex items-center">
                <div className="w-2 h-2 rounded-full bg-green-500"></div>
                <p className="ml-3 text-sm text-gray-500">ÏúóÎ™∏ÏùºÏúºÌÇ§Í∏∞ - 6:00 PM</p>
              </div>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow">
          <div className="p-6">
            <h2 className="text-lg font-medium text-gray-900">Ïò§Îäò ÏÑ≠Ï∑® ÏπºÎ°úÎ¶¨</h2>
            <div className="mt-4">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-gray-500">Calories</span>
                <span className="text-sm font-medium text-gray-900">
                  {localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')).memKcal.toLocaleString() : 'N/A'} / {localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')).memKcal.toLocaleString() : 'N/A'}
                </span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div className="bg-custom rounded-full h-2" style={{ width: '75%' }}></div>
              </div>
            </div>
            <button className="mt-4 w-full bg-custom text-white !rounded-button py-2 px-4 hover:bg-blue-500 bg-blue-400">
              <i className="fas fa-plus mr-2"></i>ÏãùÎã® Í∏∞Î°ù
            </button>
          </div>
        </div>
        <AIHealthAnalysis user={user} />
      </div>
    </main>
  );
};

export default UserHome;